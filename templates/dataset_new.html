<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>New Dataset</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{
      --bg:#f7f7fb;--card:#fff;--text:#0f172a;--muted:#6b7280;--primary:#1f6feb;--primary-2:#155ab6;
      --border:#e5e7eb;--ring:#93c5fd;--danger:#dc2626;--chip:#eef2ff;--chip-text:#3730a3;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0e14;--card:#0f131a;--text:#e6e6e6;--muted:#a3a3a3;--primary:#6ea8ff;--primary-2:#4f86db;
        --border:#1f2430;--ring:#3b82f6;--danger:#ef4444;--chip:#1b2130;--chip-text:#a5b4fc;
      }
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
    .wrap{max-width:820px;margin:4rem auto;padding:0 1rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
    .head{padding:1.25rem 1.25rem 0}
    h1{margin:.25rem 0 0;font-size:1.5rem}
    .sub{margin:.25rem 0 0;color:var(--muted);font-size:.95rem}
    form{padding:1rem 1.25rem 1.25rem}
    .grid{display:grid;gap:1rem}
    @media (min-width:720px){.grid.two{grid-template-columns:1fr 1fr}}
    label{font-weight:600;margin-bottom:.25rem;display:block}
    .hint{color:var(--muted);font-size:.85rem;margin-top:.25rem}
    .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    input[type="text"],input[type="number"],textarea,select{
      width:100%;padding:.7rem .85rem;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text);
      outline:none;box-shadow:0 0 0 0 rgba(0,0,0,0);transition:.15s;
    }
    textarea{min-height:120px;resize:vertical}
    input:focus,textarea:focus,select:focus{border-color:var(--ring);box-shadow:0 0 0 4px color-mix(in oklab, var(--ring) 22%, transparent)}
    .file-drop{
      border:2px dashed var(--border);border-radius:12px;padding:1.25rem;text-align:center;cursor:pointer;transition:.15s;
      background:linear-gradient(0deg,transparent,transparent) padding-box, repeating-linear-gradient(45deg,transparent 0 10px,#0000 10px 20px) border-box;
    }
    .file-drop.drag{border-color:var(--ring);background:rgba(59,130,246,.08)}
    .file-name{color:var(--muted);font-size:.9rem;margin-top:.5rem;word-break:break-all}
    .chips{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
    .chip{background:var(--chip);color:var(--chip-text);padding:.35rem .55rem;border-radius:999px;font-size:.85rem;display:flex;gap:.4rem;align-items:center}
    .chip button{all:unset;cursor:pointer;opacity:.8}
    .actions{display:flex;gap:.75rem;flex-wrap:wrap;margin-top:1rem}
    .btn{appearance:none;border:0;border-radius:10px;background:var(--primary);color:#fff;padding:.8rem 1rem;font-weight:600;cursor:pointer}
    .btn:hover{background:var(--primary-2)}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    .err{color:var(--danger);font-size:.9rem;margin-top:.25rem}
    .preview{margin-top:1rem;border:1px solid var(--border);border-radius:12px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{border-bottom:1px solid var(--border);padding:.5rem .6rem;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;max-width:240px}
    th{position:sticky;top:0;background:color-mix(in oklab,var(--card) 94%, black);text-align:left}
    .pill{font-size:.8rem;padding:.2rem .5rem;border-radius:999px;background:color-mix(in oklab,var(--ring) 22%, transparent)}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="row">
          <h1>üì¶ New Dataset</h1>
          <span class="pill right" title="Fields must be valid to enable submit">Validation on</span>
        </div>
        <p class="sub">Describe it clearly, tag it well, and (optionally) set a price.</p>
      </div>

      <form method="post" enctype="multipart/form-data" id="datasetForm" novalidate>
        <div class="grid">
          <div>
            <label for="title">Title</label>
            <input id="title" name="title" type="text" placeholder="e.g., S&P 500 Hourly Prices (2016-2025)" required>
            <div class="hint">Concise and descriptive. <em>Required.</em></div>
            <div class="err" id="e_title"></div>
          </div>

          <div>
            <label for="visibility">Visibility</label>
            <select id="visibility" name="visibility">
              <option value="public">üåç Public</option>
              <option value="private">üîí Private</option>
            </select>
            <div class="hint">You can change this later.</div>
          </div>
        </div>

        <div>
          <label for="description">Description</label>
          <textarea id="description" name="description" placeholder="Source, schema, frequency, caveats, intended use‚Ä¶"></textarea>
          <div class="hint">Markdown supported on view pages.</div>
        </div>

        <div>
          <label>Tags</label>
          <input id="tagInput" type="text" placeholder="Type a tag and press Enter">
          <input id="tagsField" name="tags" type="hidden" value="">
          <div class="chips" id="chips"></div>
          <div class="hint">We‚Äôll submit tags as <code>comma,separated,values</code>.</div>
        </div>

        <div class="grid two">
          <div>
            <label for="license">License</label>
            <select id="license" name="license">
              <option value="CC-BY-4.0" selected>CC-BY-4.0</option>
              <option value="MIT">MIT</option>
              <option value="GPL">GPL</option>
              <option value="proprietary">Proprietary</option>
            </select>
          </div>

          <div>
            <label for="price_cents">Price (in cents)</label>
            <input id="price_cents" name="price_cents" type="number" min="0" step="1" value="0" inputmode="numeric">
            <div class="hint">Set <b>0</b> for free. <span id="pricePretty">$0.00</span></div>
            <div class="err" id="e_price"></div>
          </div>
        </div>

        <div>
          <label>Dataset File</label>
          <div class="file-drop" id="drop">
            <strong>Drag & Drop</strong> your file here, or click to choose.
            <div class="hint">CSV/TSV/JSON are previewed. Large files show the first 10 rows.</div>
          </div>
          <input id="file" name="file" type="file" hidden required>
          <div class="file-name" id="fileName"></div>
          <div class="err" id="e_file"></div>
        </div>

        <div id="preview" class="preview" style="display:none">
          <table id="previewTable"></table>
        </div>

        <div class="actions">
          <button class="btn" id="submitBtn" type="submit" disabled>üöÄ Create Dataset</button>
          <button class="btn secondary" type="button" id="clearBtn">Reset</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---------- Helpers
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    // ---------- Elements
    const form = $('#datasetForm');
    const titleEl = $('#title');
    const priceEl = $('#price_cents');
    const pricePretty = $('#pricePretty');
    const fileInput = $('#file');
    const drop = $('#drop');
    const fileName = $('#fileName');
    const eTitle = $('#e_title');
    const ePrice = $('#e_price');
    const eFile = $('#e_file');
    const submitBtn = $('#submitBtn');
    const tagInput = $('#tagInput');
    const tagsField = $('#tagsField');
    const chips = $('#chips');
    const previewWrap = $('#preview');
    const previewTable = $('#previewTable');
    const clearBtn = $('#clearBtn');

    // ---------- Tags (chips UI, still posts as comma-separated)
    let tagList = [];
    function syncTagsField(){ tagsField.value = tagList.join(','); }
    function renderChips(){
      chips.innerHTML = '';
      tagList.forEach((t,i)=>{
        const el = document.createElement('span');
        el.className = 'chip';
        el.innerHTML = `${t}<button aria-label="Remove tag" title="Remove" data-i="${i}">‚úï</button>`;
        chips.appendChild(el);
      });
    }
    tagInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        const v = tagInput.value.trim().replace(/\s+/g,'-').replace(/,+/g,'');
        if(v && !tagList.includes(v)){
          tagList.push(v);
          syncTagsField(); renderChips();
        }
        tagInput.value = '';
      }
    });
    chips.addEventListener('click', (e)=>{
      if(e.target.matches('button[data-i]')){
        const idx = Number(e.target.dataset.i);
        tagList.splice(idx,1);
        syncTagsField(); renderChips();
      }
    });

    // ---------- Price formatter & validation
    function priceToPretty(){
      const v = Math.max(0, Number(priceEl.value || 0));
      pricePretty.textContent = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(v/100);
    }
    function validatePrice(){
      const v = Number(priceEl.value);
      if(isNaN(v) || v < 0 || !Number.isInteger(v)){
        ePrice.textContent = 'Enter a non-negative integer (cents).';
        return false;
      }
      ePrice.textContent = '';
      return true;
    }
    priceEl.addEventListener('input', ()=>{ priceToPretty(); validatePrice(); updateSubmitState(); });
    priceToPretty();

    // ---------- Title validation
    function validateTitle(){
      const ok = titleEl.value.trim().length > 2;
      eTitle.textContent = ok ? '' : 'Title must be at least 3 characters.';
      return ok;
    }
    titleEl.addEventListener('input', ()=>{ validateTitle(); updateSubmitState(); });

    // ---------- File drag/drop + quick preview
    const MAX_PREVIEW = 10; // rows/lines
    const MAX_FILE_MB = 512; // soft guard only (server allows up to 1GB per your config)
    function human(n){ return (n/1024/1024).toFixed(1) + ' MB'; }

    function pickFile(f){
      if(!f) return;
      fileName.textContent = `${f.name} ‚Äî ${human(f.size)}`;
      eFile.textContent = '';
      if(f.size/1024/1024 > MAX_FILE_MB){
        eFile.textContent = `File is quite large (${human(f.size)}). Server allows big uploads, but preview is limited.`;
      }
      previewFile(f);
      updateSubmitState();
    }

    drop.addEventListener('click', ()=> fileInput.click());
    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
    drop.addEventListener('drop', (e)=>{
      e.preventDefault(); drop.classList.remove('drag');
      const f = e.dataTransfer.files?.[0];
      if(f){ fileInput.files = e.dataTransfer.files; pickFile(f); }
    });
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files?.[0];
      if(f) pickFile(f);
    });

    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(Boolean).slice(0, MAX_PREVIEW);
      return lines.map(line=>{
        // naive CSV/TSV split; handles TSV and simple CSV (no quoted commas)
        const sep = line.includes('\t') ? '\t' : ',';
        return line.split(sep);
      });
    }
    function parseJSONPreview(text){
      try{
        const j = JSON.parse(text);
        if(Array.isArray(j)){
          // array of objects or primitives
          const arr = j.slice(0, MAX_PREVIEW);
          if(arr.length && typeof arr[0] === 'object'){
            const cols = Array.from(new Set(arr.flatMap(o=>Object.keys(o))));
            const rows = arr.map(o=> cols.map(c => String(o?.[c] ?? '')));
            return { header: cols, rows };
          } else {
            return { header: ['value'], rows: arr.map(x=>[String(x)]) };
          }
        }else if(typeof j === 'object' && j !== null){
          const keys = Object.keys(j).slice(0, MAX_PREVIEW);
          return { header: ['key','value'], rows: keys.map(k=>[k, String(j[k])]) };
        }
      }catch(e){}
      // fallback: line preview
      const lines = text.split(/\r?\n/).slice(0, MAX_PREVIEW).map(x=>[x]);
      return { header: ['value'], rows: lines };
    }

    function renderTable(header, rows){
      previewTable.innerHTML = '';
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      (header || []).forEach(h=>{
        const th = document.createElement('th'); th.textContent = h; trh.appendChild(th);
      });
      thead.appendChild(trh);
      const tbody = document.createElement('tbody');
      (rows || []).forEach(r=>{
        const tr = document.createElement('tr');
        r.forEach(c=>{
          const td = document.createElement('td'); td.textContent = c; tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      previewTable.appendChild(thead); previewTable.appendChild(tbody);
      previewWrap.style.display = 'block';
    }

    function previewFile(file){
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      const reader = new FileReader();
      reader.onload = function(){
        const text = reader.result;
        if(['csv','tsv'].includes(ext)){
          const rows = parseCSV(text);
          const header = rows.length ? rows[0] : [];
          const body = rows.slice(1);
          renderTable(header, body);
        }else if(['json','geojson','ndjson'].includes(ext)){
          const {header, rows} = parseJSONPreview(text);
          renderTable(header, rows);
        }else{
          // generic preview: first 10 lines
          const lines = String(text).split(/\r?\n/).slice(0, MAX_PREVIEW).map(x=>[x]);
          renderTable(['preview'], lines);
        }
      };
      // Read as text for preview; server still receives the raw file via form-data
      reader.readAsText(file.slice(0, 2_000_000)); // read first ~2MB for quick preview
    }

    // ---------- Submit gating
    function validateFile(){
      const ok = fileInput.files && fileInput.files.length > 0;
      eFile.textContent = ok ? '' : 'Please select a file.';
      return ok;
    }
    function updateSubmitState(){
      const ok = validateTitle() && validatePrice() && validateFile();
      submitBtn.disabled = !ok;
    }

    // ---------- Reset
    clearBtn.addEventListener('click', ()=>{
      form.reset();
      tagList = []; syncTagsField(); renderChips();
      fileName.textContent = ''; previewTable.innerHTML=''; previewWrap.style.display='none';
      eTitle.textContent = ePrice.textContent = eFile.textContent = '';
      priceToPretty(); updateSubmitState();
      titleEl.focus();
    });

    // ---------- Init
    updateSubmitState();
  </script>
</body>
</html>
