<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live Notebook Editor with Matplotlib</title>
  <style>
    :root {
      --bg-color: #1e1e1e;
      --text-color: #e0e0e0;
      --cell-bg: #252526;
      --border-color: #3c3c3c;
      --button-bg: #333;
      --button-hover: #444;
      --output-bg: #1e1e1e;
      --output-color: #9cdcfe;
      --success-color: #4CAF50;
      --error-color: #f44336;
      --toolbar-bg: #252526;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
    }
    .drag-handle {
      cursor: grab;
      user-select: none;
      font-size: 18px;
      margin-bottom: 8px;
      color: #888;
    }


    .toolbar {
      background-color: var(--toolbar-bg);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      background-color: var(--button-bg);
      color: var(--text-color);
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .cell {
      background-color: var(--cell-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .editor-wrapper {
      height: 200px;
      border: 1px solid var(--border-color);
      margin-bottom: 10px;
    }

    .output {
      background-color: var(--output-bg);
      color: var(--output-color);
      padding: 12px;
      border-left: 4px solid var(--success-color);
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    .output.error {
      border-left-color: var(--error-color);
    }

    .plot-container {
      margin: 15px 0;
      background-color: var(--cell-bg);
      padding: 10px;
      border-radius: 4px;
    }

    .plot-image {
      max-width: 100%;
    }

    .markdown-preview {
      padding: 12px;
      background-color: var(--cell-bg);
      border-radius: 4px;
      border-left: 4px solid #ffc107;
    }

    .markdown-preview h1, 
    .markdown-preview h2, 
    .markdown-preview h3 {
      margin-top: 0;
    }

    .markdown-preview code {
      background-color: rgba(0, 0, 0, 0.1);
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
    }

    .markdown-preview pre {
      background-color: rgba(0, 0, 0, 0.1);
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }

    .cell-controls {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
</head>

<body>
<div class="toolbar">
  <h2 style="margin: 0; flex-grow: 1;">üìì Notebook Editor</h2>
  <button id="addCode">‚ûï Add Code Cell</button>
  <button id="addMarkdown">‚ûï Add Markdown</button>
  <button id="runAll">‚ñ∂Ô∏è Run All</button>
  <button id="save">üíæ Save Notebook</button>
</div>

<div id="cells"></div>

<script>
  // Initialize with empty array if no cells provided
  const preloadedCells = [];
  const notebookTitle = "Untitled Notebook";
  
  let editors = [];
  const cellsDiv = document.getElementById("cells");

  function createCodeCell(monaco, content = "", output = "") {
    const wrapper = document.createElement("div");
    wrapper.className = "cell";
    wrapper.setAttribute("draggable", "true");
    const dragHandle = document.createElement("div");
    dragHandle.className = "drag-handle";
    dragHandle.innerHTML = "‚ò∞ Drag";
    wrapper.appendChild(dragHandle);

    
    const editorContainer = document.createElement("div");
    editorContainer.className = "editor-wrapper";
    wrapper.appendChild(editorContainer);
    
    const outputDiv = document.createElement("div");
    outputDiv.className = "output";
    if (output) {
      if (output.plot) {
        renderPlot(outputDiv, output.plot);
      } else {
        outputDiv.innerHTML = `<pre>${output}</pre>`;
      }
    }
    wrapper.appendChild(outputDiv);
    
    const controls = document.createElement("div");
    controls.className = "cell-controls";
    
    const runBtn = document.createElement("button");
    runBtn.textContent = "‚ñ∂Ô∏è Run";
    controls.appendChild(runBtn);
    
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "üóëÔ∏è Delete";
    controls.appendChild(deleteBtn);
    
    wrapper.appendChild(controls);
    cellsDiv.appendChild(wrapper);
    
    const editor = monaco.editor.create(editorContainer, {
      value: content,
      language: "python",
      theme: "vs-dark",
      automaticLayout: true
    });
    
    const record = { 
      type: "code", 
      editor, 
      outputDiv,
      wrapper 
    };
    editors.push(record);
    
    runBtn.onclick = () => {
      outputDiv.innerHTML = "<pre>‚è≥ Running...</pre>";
      const code = editor.getValue();
      
      fetch("/app/evaluate_plot", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code })
      })
      .then(res => res.json())
      .then(data => {
        if (data.plot) {
          renderPlot(outputDiv, data.plot);
        } else {
          outputDiv.innerHTML = `<pre>${data.result || "‚úÖ Execution successful"}</pre>`;
        }
      })
      .catch(err => {
        outputDiv.className = "output error";
        outputDiv.innerHTML = `<pre>‚ùå Error: ${err.message || "Failed to execute code"}</pre>`;
      });
    };
    
    deleteBtn.onclick = () => {
      wrapper.remove();
      editors = editors.filter(e => e.editor !== editor);
    };
  }

  function createMarkdownCell(monaco, content = "# Markdown Cell") {
    const wrapper = document.createElement("div");
    wrapper.className = "cell";
    wrapper.setAttribute("draggable", "true");
    const dragHandle = document.createElement("div");
    dragHandle.className = "drag-handle";
    dragHandle.innerHTML = "‚ò∞ Drag";
    wrapper.appendChild(dragHandle);

    
    
    const editorContainer = document.createElement("div");
    editorContainer.className = "editor-wrapper";
    editorContainer.style.height = "150px";
    wrapper.appendChild(editorContainer);
    
    const preview = document.createElement("div");
    preview.className = "markdown-preview";
    preview.style.display = "none";
    wrapper.appendChild(preview);
    
    const controls = document.createElement("div");
    controls.className = "cell-controls";
    
    const toggleBtn = document.createElement("button");
    toggleBtn.textContent = "üëÅÔ∏è Preview";
    controls.appendChild(toggleBtn);
    
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "üóëÔ∏è Delete";
    controls.appendChild(deleteBtn);
    
    wrapper.appendChild(controls);
    cellsDiv.appendChild(wrapper);
    
    const editor = monaco.editor.create(editorContainer, {
      value: content,
      language: "markdown",
      theme: "vs-dark",
      automaticLayout: true
    });
    
    const record = { 
      type: "markdown", 
      editor,
      preview,
      wrapper 
    };
    editors.push(record);
    
    // Initial render if content exists
    if (content.trim()) {
      preview.innerHTML = marked.parse(content);
    }
    
    // Update preview on content change
    editor.onDidChangeModelContent(() => {
      if (preview.style.display === "block") {
        preview.innerHTML = marked.parse(editor.getValue());
      }
    });
    
    toggleBtn.onclick = () => {
      const isPreview = preview.style.display === "block";
      preview.style.display = isPreview ? "none" : "block";
      editorContainer.style.display = isPreview ? "block" : "none";
      toggleBtn.textContent = isPreview ? "üëÅÔ∏è Preview" : "‚úèÔ∏è Edit";
      
      if (!isPreview) {
        preview.innerHTML = marked.parse(editor.getValue());
      }
    };
    
    deleteBtn.onclick = () => {
      wrapper.remove();
      editors = editors.filter(e => e.editor !== editor);
    };
  }

  function renderPlot(container, plotData) {
    container.innerHTML = `
      <div class="plot-container">
        <img class="plot-image" src="data:image/png;base64,${plotData}">
      </div>
    `;
  }

  function saveNotebook() {
    const name = prompt("Notebook name:");
    const notebook = editors.map(e => ({
      type: e.type,
      content: e.editor.getValue()
    }));
    
    fetch("/app/sequential/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, notebook })
    })
    .then(res => res.json())
    .then(data => alert(data.message || "‚úÖ Saved"))
    .catch(err => alert("‚ùå Save failed: " + err.message));
  }
  let draggedElement = null;
  
  cellsDiv.addEventListener("dragstart", (e) => {
    draggedElement = e.target.closest(".cell");
    if (draggedElement) draggedElement.classList.add("dragging");
  });
  
  cellsDiv.addEventListener("dragend", (e) => {
    if (draggedElement) draggedElement.classList.remove("dragging");
    draggedElement = null;
  });
  
  cellsDiv.addEventListener("dragover", (e) => {
    e.preventDefault();
    const afterElement = getDragAfterElement(cellsDiv, e.clientY);
    const dragging = document.querySelector(".cell.dragging");
    if (afterElement == null) {
      cellsDiv.appendChild(dragging);
    } else {
      cellsDiv.insertBefore(dragging, afterElement);
    }
  });
  
  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll(".cell:not(.dragging)")];
    
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // Initialize Monaco Editor
  require.config({ paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs" }});
  require(["vs/editor/editor.main"], function(monaco) {
    // Add initial code cell
    createCodeCell(monaco, `import matplotlib.pyplot as plt
import numpy as np

# Sample plot
x = np.linspace(0, 10, 100)
plt.plot(x, np.sin(x))
plt.title('Sine Wave')
plt.show()`);

    // Add toolbar event listeners
    document.getElementById("addCode").onclick = () => createCodeCell(monaco);
    document.getElementById("addMarkdown").onclick = () => createMarkdownCell(monaco);
    document.getElementById("runAll").onclick = () => {
      editors.forEach(e => {
        if (e.type === "code") {
          e.wrapper.querySelector("button").click();
        }
      });
    };
    document.getElementById("save").onclick = saveNotebook;
  });
</script>
</body>
</html>