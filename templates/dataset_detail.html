<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>{{ d.title }} ‚Äî Dataset</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{
      --bg:#f7f7fb;--card:#fff;--text:#0f172a;--muted:#6b7280;--border:#e5e7eb;
      --brand:#1f6feb;--brand-2:#155ab6;--good:#10b981;--warn:#f59e0b;--danger:#dc2626;
      --chip:#eef2ff;--chip-text:#3730a3;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0e14;--card:#0f131a;--text:#e6e6e6;--muted:#a3a3a3;--border:#1f2430;
        --brand:#6ea8ff;--brand-2:#4f86db;--good:#34d399;--warn:#fbbf24;--danger:#ef4444;
        --chip:#1b2130;--chip-text:#a5b4fc;
      }
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:2rem auto;padding:0 1rem}
    .row{display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
    .spacer{flex:1 1 auto}
    .badge{font-size:.8rem;padding:.18rem .5rem;border-radius:999px;border:1px solid var(--border)}
    .btn{appearance:none;border:1px solid var(--border);border-radius:10px;padding:.6rem .9rem;font-weight:600;cursor:pointer}
    .btn.brand{background:var(--brand);border-color:transparent;color:#fff}
    .btn.brand:hover{background:var(--brand-2)}
    .btn.ghost{background:transparent;color:var(--text)}
    .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
    header.page{margin-bottom:1rem}
    header.page h1{margin:.25rem 0 0;font-size:1.6rem}
    .sub{color:var(--muted);margin:0}
    .panel{padding:1rem}
    .meta{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .meta .price{background:color-mix(in oklab,var(--good) 18%, transparent);border:0}
    .meta .vis{background:color-mix(in oklab,var(--warn) 18%, transparent);border:0}
    .chips{display:flex;gap:.4rem;flex-wrap:wrap}
    .chip{background:var(--chip);color:var(--chip-text);padding:.25rem .55rem;border-radius:999px;font-size:.8rem}
    .stickybar{position:sticky;top:0;z-index:5;background:color-mix(in oklab,var(--card) 92%, black);
      border:1px solid var(--border);border-radius:12px;padding:.5rem .75rem;margin:1rem 0}
    .grid{display:grid;gap:1rem}
    @media (min-width:960px){.grid{grid-template-columns:2fr 1fr}}
    h3{margin:0 0 .6rem}
    /* Preview table */
    .preview-wrap{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:420px}
    table{width:100%;border-collapse:collapse;font-size:.92rem}
    th,td{border-bottom:1px solid var(--border);padding:.5rem .6rem;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    th{position:sticky;top:0;background:color-mix(in oklab,var(--card) 94%, black);text-align:left}
    /* Versions */
    .versions{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .versions table{font-size:.92rem}
    /* Forms */
    input[type="text"],input[type="number"],textarea,select{
      width:100%;padding:.6rem .75rem;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text);
      outline:none;transition:.15s;
    }
    textarea{min-height:120px;resize:vertical}
    input:focus,textarea:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 4px color-mix(in oklab,var(--brand) 24%, transparent)}
    .hint{color:var(--muted);font-size:.85rem;margin-top:.25rem}
    .err{color:var(--danger);font-size:.9rem;margin-top:.25rem}
    .drop{border:2px dashed var(--border);border-radius:12px;padding:1.2rem;text-align:center;cursor:pointer}
    .drop.drag{border-color:var(--brand);background:rgba(59,130,246,.08)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Title / actions -->
    <header class="page row">
      <div>
        <h1>{{ d.title }}</h1>
        <p class="sub">{{ (d.description or '')|truncate(200, True, '‚Ä¶') }}</p>
      </div>
      <span class="spacer"></span>
      {% if current_user.is_authenticated and current_user.id != d.owner_id and d.price_cents > 0 %}
        <form method="post" action="{{ url_for('datasets.dataset_buy', dataset_id=d.id) }}">
          <button class="btn brand">Buy for {{ (d.price_cents/100)|round(2) }}</button>
        </form>
      {% endif %}
      {% if current_user.is_authenticated %}
        <a class="btn ghost" href="{{ url_for('datasets.dataset_index') }}">‚Üê Back</a>
      {% endif %}
    </header>

    <!-- Sticky info bar -->
    <div class="stickybar row">
      <div class="meta">
        <span class="badge price" id="priceBadge">${{ ((d.price_cents or 0)/100)|round(2) }}</span>
        <span class="badge">{{ d.license }}</span>
        <span class="badge vis">{% if d.visibility=='private' %}üîí Private{% else %}üåç Public{% endif %}</span>
      </div>
      <span class="spacer"></span>
      <div class="chips">
        {% for t in d.tag_list() %}
          <span class="chip">{{ t }}</span>
        {% endfor %}
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Preview + Versions -->
      <section class="card panel">
        <h3>Latest Preview</h3>
        {% if sample and sample|length %}
          <div class="preview-wrap">
            <table>
              <thead>
                <tr>
                  {% for k in sample[0].keys() %}
                    <th>{{ k }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in sample %}
                  <tr>
                    {% for v in row.values() %}
                      <td title="{{ v }}">{{ v }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="hint"><em>No preview available.</em></p>
        {% endif %}

        <h3 style="margin-top:1rem">Versions</h3>
        {% if d.versions %}
          <div class="versions">
            <table>
              <thead>
                <tr>
                  <th>Version</th>
                  <th>Filename</th>
                  <th>Size</th>
                  <th>Uploaded</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for v in d.versions %}
                  <tr>
                    <td>{{ v.version }}</td>
                    <td title="{{ v.filename }}">{{ v.filename }}</td>
                    <td>{{ '{:,}'.format(v.file_size or 0) }} bytes</td>
                    <td>{{ v.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                      {% if current_user.is_authenticated %}
                        <a class="btn ghost" href="{{ url_for('datasets.dataset_download', dataset_id=d.id, version=v.version) }}">Download</a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="hint"><em>No versions uploaded yet.</em></p>
        {% endif %}
      </section>

      <!-- RIGHT: Owner actions -->
      <aside class="grid" style="gap:1rem">
        {% if current_user.is_authenticated and current_user.id == d.owner_id %}
          <section class="card panel">
            <h3>Upload New Version</h3>
            <form method="post" enctype="multipart/form-data" action="{{ url_for('datasets.dataset_upload_version', dataset_id=d.id) }}" id="verForm">
              <div class="drop" id="drop">
                Drag & Drop file here, or click to choose.
              </div>
              <input type="file" name="file" id="file" hidden required>
              <div class="hint" id="fileHint"></div>
              <div class="row" style="margin-top:.75rem">
                <span class="spacer"></span>
                <button class="btn brand">Upload</button>
              </div>
            </form>
          </section>

          <section class="card panel">
            <h3>Edit Metadata</h3>
            <form method="post" action="{{ url_for('datasets.dataset_edit', dataset_id=d.id) }}" id="editForm" novalidate>
              <label>Title</label>
              <input type="text" name="title" value="{{ d.title }}" placeholder="Title" required>
              <div class="err" id="e_title"></div>

              <label style="margin-top:.6rem">Description</label>
              <textarea name="description" placeholder="Description">{{ d.description }}</textarea>
              <div class="hint">Markdown supported on view pages.</div>

              <label style="margin-top:.6rem">Tags</label>
              <input type="text" id="tagsIn" value="{{ d.tags or '' }}" placeholder="tag1, tag2">
              <input type="hidden" name="tags" id="tagsField" value="{{ d.tags or '' }}">
              <div class="chips" id="chips" style="margin-top:.4rem"></div>
              <div class="hint">We‚Äôll submit as comma-separated.</div>

              <div class="row" style="margin-top:.6rem">
                <div style="flex:1">
                  <label>License</label>
                  <input type="text" name="license" value="{{ d.license }}">
                </div>
                <div style="flex:1">
                  <label>Visibility</label>
                  <select name="visibility">
                    <option value="public" {% if d.visibility=='public' %}selected{% endif %}>public</option>
                    <option value="private" {% if d.visibility=='private' %}selected{% endif %}>private</option>
                  </select>
                </div>
              </div>

              <label style="margin-top:.6rem">Price (¬¢)</label>
              <input type="number" name="price_cents" id="price" value="{{ d.price_cents or 0 }}" min="0" step="1">
              <div class="hint">Pretty: <span id="pricePretty">$0.00</span></div>
              <div class="err" id="e_price"></div>

              <div class="row" style="margin-top:.9rem">
                <button class="btn brand" type="submit">Save</button>
                <span class="spacer"></span>
                <form method="post" action="{{ url_for('datasets.dataset_delete', dataset_id=d.id) }}" onsubmit="return confirm('Delete dataset?');">
                  <button class="btn danger">Delete Dataset</button>
                </form>
              </div>
            </form>
          </section>
        {% else %}
          <section class="card panel">
            <h3>About</h3>
            <p>{{ d.description }}</p>
            <div class="meta" style="margin-top:.5rem">
              <span class="badge">{{ d.license }}</span>
              <span class="badge">{% if d.visibility=='private' %}üîí Private{% else %}üåç Public{% endif %}</span>
              <span class="badge">Price: ${{ ((d.price_cents or 0)/100)|round(2) }}</span>
            </div>
          </section>
        {% endif %}
      </aside>
    </div>

    {% if current_user.is_authenticated and current_user.id != d.owner_id and d.price_cents > 0 %}
      <section class="card panel" style="margin-top:1rem">
        <h3>Purchase</h3>
        <form method="post" action="{{ url_for('datasets.dataset_buy', dataset_id=d.id) }}" onsubmit="return confirm('Confirm purchase?');">
          <div class="row">
            <div class="hint">You‚Äôll get access to all versions.</div>
            <span class="spacer"></span>
            <button class="btn brand">Buy for {{ (d.price_cents/100)|round(2) }}</button>
          </div>
        </form>
      </section>
    {% endif %}
  </div>

  <script>
    // ----- Price pretty-print
    const priceEl = document.getElementById('price');
    const pretty = document.getElementById('pricePretty');
    const priceBadge = document.getElementById('priceBadge');
    const fmt = (c)=> new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format((+c||0)/100);
    function syncPrice(){
      if(!priceEl) return;
      const v = priceEl.value || 0;
      if(pretty) pretty.textContent = fmt(v);
      if(priceBadge) priceBadge.textContent = fmt(v);
    }
    if(priceEl){ priceEl.addEventListener('input', syncPrice); syncPrice(); }

    // ----- Validate title & price on owner edit
    const editForm = document.getElementById('editForm');
    if(editForm){
      editForm.addEventListener('submit', (e)=>{
        const title = editForm.querySelector('input[name="title"]').value.trim();
        const priceC = +editForm.querySelector('input[name="price_cents"]').value;
        let ok = true;
        const eTitle = document.getElementById('e_title');
        const ePrice = document.getElementById('e_price');
        if(title.length < 3){ eTitle.textContent = 'Title must be at least 3 chars.'; ok=false; } else { eTitle.textContent=''; }
        if(isNaN(priceC) || priceC < 0 || !Number.isInteger(priceC)){ ePrice.textContent = 'Enter a non-negative integer (cents).'; ok=false; } else { ePrice.textContent=''; }
        if(!ok) e.preventDefault();
      });
    }

    // ----- Tags chips builder (still posts comma-separated)
    const tagsIn = document.getElementById('tagsIn');
    const tagsField = document.getElementById('tagsField');
    const chips = document.getElementById('chips');
    function renderChips(){
      if(!chips) return;
      chips.innerHTML = '';
      const list = (tagsField.value || '').split(',').map(s=>s.trim()).filter(Boolean);
      list.forEach((t,i)=>{
        const span = document.createElement('span');
        span.className='chip';
        span.innerHTML = `${t} <a href="#" data-i="${i}" title="Remove">‚úï</a>`;
        chips.appendChild(span);
      });
    }
    function syncFromInput(){
      const clean = (tagsIn.value||'').split(',').map(s=>s.trim().replace(/\s+/g,'-')).filter(Boolean).join(',');
      tagsField.value = clean;
      renderChips();
    }
    if(tagsIn && tagsField){ tagsIn.addEventListener('input', syncFromInput); renderChips(); }

    if(chips){
      chips.addEventListener('click', (e)=>{
        const i = e.target.getAttribute('data-i');
        if(i==null) return;
        e.preventDefault();
        const list = (tagsField.value || '').split(',').filter(Boolean);
        list.splice(+i,1);
        tagsField.value = list.join(',');
        tagsIn.value = list.join(', ');
        renderChips();
      });
    }

    // ----- Drag & drop for "Upload New Version"
    const drop = document.getElementById('drop');
    const file = document.getElementById('file');
    const fileHint = document.getElementById('fileHint');
    if(drop && file){
      drop.addEventListener('click', ()=> file.click());
      drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
      drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
      drop.addEventListener('drop', (e)=>{
        e.preventDefault(); drop.classList.remove('drag');
        if(e.dataTransfer.files?.length){ file.files = e.dataTransfer.files; fileHint.textContent = e.dataTransfer.files[0].name; }
      });
      file.addEventListener('change', ()=>{ if(file.files?.length) fileHint.textContent = file.files[0].name; });
    }
  </script>
</body>
</html>
